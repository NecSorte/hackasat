<!DOCTYPE html>
<html>
<head>
    <title>Device Scanner</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Device Scanner</h1>

        <div id="serial-ports" class="mb-3">
            <h2>Serial Ports</h2>
            <select id="port-selector" class="form-control">
                {% for port in serial_ports %}
                    <option value="{{ port }}">{{ port }}</option>
                {% endfor %}
            </select>
            <textarea id="command-input" class="form-control mt-2" placeholder="Enter command"></textarea>
            <button id="send-command-button" class="btn btn-primary mt-2">Send Command</button>
            <div id="command-response" class="mt-2"></div>
        </div>

        <div id="network-interfaces" class="mb-3">
            <h2>Network Interfaces</h2>
            <select id="interface-selector" class="form-control">
                {% for interface in network_interfaces %}
                    <option value="{{ interface }}">{{ interface }}</option>
                {% endfor %}
            </select>
            <button id="wifi-scan-button" class="btn btn-primary mt-2">Start WiFi Scan</button>
            <button id="array-scan-button" class="btn btn-primary mt-2">Start Array Scan</button>

            <div id="wifi-scan-results" class="mt-2"></div>
        </div>

        <div id="wifi-details" class="mb-3">
            <h2>WiFi Details</h2>
            <table id="wifi-details-table" class="table table-striped">
                <thead>
                    <tr>
                        <th>MAC Address</th>
                        <th>frequency</th>
                        <th>rate</th>
                        <th>keys</th>
                        <th>power</th>
                        <th>txpower</th>
                        <th>retry</th>
                        <th>event</th>
                        <th>auth</th>
                        <th>wpakeys</th>
                        <th>genie</th>
                        <th>modulation</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>


<script>
$(document).ready(function() {
    var intervalId;
    var commands = ["frequency", "rate", "keys", "power", "txpower", "retry", "event", "auth", "wpakeys", "genie", "modulation"];

    $.get('/get_serial_ports', function(data) {
        data.forEach(function(port) {
            $('#port-selector').append($('<option>', {
                value: port,
                text: port
            }));
        });
    });

    $.get('/get_network_interfaces', function(data) {
        data.forEach(function(interface) {
            $('#interface-selector').append($('<option>', {
                value: interface,
                text: interface
            }));
        });
    });

    $('#send-command-button').click(function() {
        $.post('/send_command', {
            port: $('#port-selector').val(),
            command: $('#command-input').val()
        }, function(data) {
            $('#command-response').text(data.response);
        });
    });

    // Define the start and end values for azimuth and elevation
    const AZIMUTH_START = 160;
    const AZIMUTH_END = 6400;
    const ELEVATION_START = 650;
    const ELEVATION_END = 1400;

    // Define the current azimuth and elevation
    var currentAzimuth = AZIMUTH_START;
    var currentElevation = ELEVATION_START;

    // Define the increment values for azimuth and elevation
    var azimuthIncrement = 100;  // adjust as needed
    var elevationIncrement = 50;  // adjust as needed

    // Array scan button click event handler
    $('#array-scan-button').click(function() {
        arrayScan(); // Starts the array scan when the button is clicked
    });

    // Define the function to perform an array scan
    function arrayScan() {
        // Call the /array_scan endpoint
        $.post('/array_scan', {
            interface: $('#interface-selector').val(),
            azimuth: currentAzimuth,
            elevation: currentElevation
        }, function(data) {
            populateWifiDetailsTable(data.devices);
        });

        // Increment the azimuth and elevation for the next scan
        currentAzimuth += azimuthIncrement;
        currentElevation += elevationIncrement;

        // If we've reached the end of the azimuth range, reset to the start and move to the next elevation
        if (currentAzimuth > AZIMUTH_END) {
            currentAzimuth = AZIMUTH_START;
            currentElevation += elevationIncrement;
        }

        // If we've reached the end of the elevation range, reset to the start
        if (currentElevation > ELEVATION_END) {
            currentElevation = ELEVATION_START;
        }

        // Call the function again after a delay to create a loop
        setTimeout(arrayScan, 1000);  // adjust delay as needed
    }
    
    $('#wifi-scan-button').click(function() {
        // If there's already an interval, clear it
        if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
        }

        // Perform the first scan immediately upon button click
        wifiScan();

        // Set up the interval for subsequent scans
        intervalId = setInterval(wifiScan, 5000); // 1000 ms = 1 second
    });

    // Define the function to perform a wifi scan
    function wifiScan() {
        $.post('/wifi_scan', {
            interface: $('#interface-selector').val()
        }, function(data) {
            populateWifiDetailsTable(data.devices);
        });
    }

    function populateWifiDetailsTable(scanResults) {
        var tableBody = $('#wifi-details-table tbody');
        tableBody.empty();

        scanResults.forEach(function(device) {
            var row = $('<tr>');
            row.append($('<td>').text(device.mac));
            row.append($('<td>').text(device.essid));
            row.append($('<td>').text(device.protocol));
            row.append($('<td>').text(device.mode));
            row.append($('<td>').text(device.frequency));
            row.append($('<td>').text(device.encryption));
            row.append($('<td>').text(device.rate));
            row.append($('<td>').text(device.signal));

            tableBody.append(row);
        });
    }

});
</script>
</body>
</html>
