<!DOCTYPE html>
<html>
<head>
    <title>Device Scanner</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Device Scanner</h1>

        <div id="network-interfaces" class="mb-3">
            <h2>Network Interfaces</h2>
            <select id="interface-selector" class="form-control"></select>
            <button id="wifi-scan-button" class="btn btn-primary mt-2">Start WiFi Scan</button>
            
            <table id="wifi-details-table" class="table table-striped mt-2">
                <thead>
                    <tr>
                        <th>MAC Address</th>
                        <th>ESSID</th>
                        <th>Mode</th>
                        <th>Channel</th>
                        <th>Frequency</th>
                        <th>Quality</th>
                        <th>Signal Level</th>
                        <th>Noise Level</th>
                        <th>Encryption</th>
                    </tr>
                </thead>

                <tbody></tbody>
            </table>
        </div>
    </div>

<script>
$(document).ready(function() {
    var intervalId;

    // State variable to keep track of whether wifi scanning is active
    var wifiScanActive = false;

    // Function to populate the table with device data
    function populateWifiDetailsTable(devices) {
        var tbody = $('#wifi-details-table tbody');
        tbody.empty();

        devices.forEach(function(device) {
            var row = `<tr>
                <td>${device.mac}</td>
                <td>${device.essid}</td>
                <td>${device.mode}</td>
                <td>${device.channel}</td>
                <td>${device.frequency}</td>
                <td>${device.quality}</td>
                <td>${device.signal}</td>
                <td>${device.noise}</td>
                <td>${device.encryption}</td>
            </tr>`;
            tbody.append(row);
        });
    }

    // Function to fetch device data from Elasticsearch
    function fetchDeviceData() {
        var interface = $('#interface-selector').val();

        $.ajax({
            url: '/get_device_data',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ interface: interface }),
            success: function(data) {
                populateWifiDetailsTable(data.devices);
            },
            error: function() {
                console.log('Failed to retrieve devices');
            }
        });
    }

    // Fetch network interfaces and populate the select element
    $.get('/get_network_interfaces', function(data) {
        data.forEach(function(interface) {
            $('#interface-selector').append($('<option>', {
                value: interface,
                text: interface
            }));
        });
    });

    $('#wifi-scan-button').click(function() {
        wifiScanActive = !wifiScanActive; // Toggle the wifi scan state

        // Update the wifi scan button appearance
        if (wifiScanActive) {
            $(this).text('Stop WiFi Scan').addClass('btn-danger').removeClass('btn-primary');
            // Set up the interval for subsequent scans
            intervalId = setInterval(fetchDeviceData, 5000); // Adjust the interval as needed
            fetchDeviceData(); // Fetch initial device data immediately
        } else {
            $(this).text('Start WiFi Scan').addClass('btn-primary').removeClass('btn-danger');
            // If there's an interval, clear it
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }
    });
});
</script>
</body>
</html>
