<!DOCTYPE html>
<html>
<head>
    <title>Device Scanner</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Device Scanner</h1>

        <div id="serial-ports" class="mb-3">
            <h2>Serial Ports</h2>
            <select id="port-selector" class="form-control">
                {% for port in serial_ports %}
                    <option value="{{ port }}">{{ port }}</option>
                {% endfor %}
            </select>
            <textarea id="command-input" class="form-control mt-2" placeholder="Enter command"></textarea>
            <button id="send-command-button" class="btn btn-primary mt-2">Send Command</button>
            <div id="command-response" class="mt-2"></div>
        </div>

        <div id="network-interfaces" class="mb-3">
            <h2>Network Interfaces</h2>
            <select id="interface-selector" class="form-control">
                {% for interface in network_interfaces %}
                    <option value="{{ interface }}">{{ interface }}</option>
                {% endfor %}
            </select>
            <button id="wifi-scan-button" class="btn btn-primary mt-2">Start WiFi Scan</button>
            <button id="array-scan-button" class="btn btn-primary mt-2">Start Array Scan</button>

            <div id="wifi-scan-results" class="mt-2"></div>
        </div>

        <div id="wifi-details" class="mb-3">
            <h2>WiFi Details</h2>
            <table id="wifi-details-table" class="table table-striped">
                <thead>
                    <tr>
                        <th>Actions</th>
                        <th>MAC Address</th>
                        <th>ESSID</th>
                        <th>Mode</th>
                        <th>Channel</th>
                        <th>Frequency</th>
                        <th>Quality</th>
                        <th>Signal Level</th>
                        <th>Noise Level</th>
                        <th>Encryption</th>
                        <th>MANUF Intel</th>
                    </tr>
                </thead>

                <tbody>
                </tbody>
            </table>
        </div>


<script>
$(document).ready(function() {
    var intervalId;
    var commands = ["frequency", "rate", "keys", "power", "txpower", "retry", "event", "auth", "wpakeys", "genie", "modulation"];

    // State variables to keep track of whether wifi and array scanning are active
    var wifiScanActive = false;
    var arrayScanActive = false;
    
    $.get('/get_serial_ports', function(data) {
        data.forEach(function(port) {
            $('#port-selector').append($('<option>', {
                value: port,
                text: port
            }));
        });
    });

    $.get('/get_network_interfaces', function(data) {
        data.forEach(function(interface) {
            $('#interface-selector').append($('<option>', {
                value: interface,
                text: interface
            }));
        });
    });

    $('#send-command-button').click(function() {
        $.post('/send_command', {
            port: $('#port-selector').val(),
            command: $('#command-input').val()
        }, function(data) {
            $('#command-response').text(data.response);
        });
    });

    // Define the start and end values for azimuth and elevation
    const AZIMUTH_START = 160;
    const AZIMUTH_END = 6400;
    const ELEVATION_START = 650;
    const ELEVATION_END = 1400;

    // Define the current azimuth and elevation
    var currentAzimuth = AZIMUTH_START;
    var currentElevation = ELEVATION_START;

    // Define the increment values for azimuth and elevation
    var azimuthIncrement = 100;  // adjust as needed
    var elevationIncrement = 50;  // adjust as needed

    // Array scan button click event handler
    $('#array-scan-button').click(function() {
        arrayScanActive = !arrayScanActive; // Toggle the array scan state

        // Update the array scan button appearance
        if (arrayScanActive) {
            $(this).text('Stop Array Scan').addClass('btn-danger').removeClass('btn-primary');
            arrayScan();
        } else {
            $(this).text('Start Array Scan').addClass('btn-primary').removeClass('btn-danger');
            // You would also need to figure out how to stop the arrayScan function once it's been started
        }
    });

    $('.track-button').click(function() {
    var macAddress = $(this).data('mac');
    $.ajax({
        type: 'POST',
        url: '/track_device',
        data: JSON.stringify({
            'mac_address': macAddress
        }),
        contentType: 'application/json;charset=UTF-8',
        success: function(data) {
            console.log(data);
        },
        error: function() {
            console.log('Failed to track device');
        }
    });
});
    
    // Define the arrayScan timeout ID outside the arrayScan function
    var arrayScanTimeoutId = null;

    // Define the function to perform an array scan
    function arrayScan() {
        // Only execute the scan if the arrayScanActive flag is true
        if (arrayScanActive) {
            // Call the /array_scan endpoint
            $.post('/array_scan', {
                port: $('#port-selector').val(),
                azimuth: currentAzimuth,
                elevation: currentElevation
            }, function(data) {
                populateWifiDetailsTable(data.devices);
            });

            // Increment the azimuth and elevation for the next scan
            currentAzimuth += azimuthIncrement;
            currentElevation += elevationIncrement;

            // If we've reached the end of the azimuth range, reset to the start and move to the next elevation
            if (currentAzimuth > AZIMUTH_END) {
                currentAzimuth = AZIMUTH_START;
                currentElevation += elevationIncrement;
            }

            // If we've reached the end of the elevation range, reset to the start
            if (currentElevation > ELEVATION_END) {
                currentElevation = ELEVATION_START;
            }

            // Call the function again after a delay to create a loop, saving the timeout ID
            arrayScanTimeoutId = setTimeout(arrayScan, 5000);  // adjust delay as needed 1000 = 1 second
        }
    }

        // Update the trackDevice function to track a specific MAC address
    function trackDevice(macAddress) {
      // Make a POST request to the server to start tracking the device
      $.ajax({
        type: 'POST',
        url: '/track_device',
        data: {
          mac_address: macAddress
        },
        success: function(response) {
          console.log(response);
          // Handle the success response
        },
        error: function(error) {
          console.log(error);
          // Handle the error response
        }
      });
    }

// Add event listener to track button in each row
$(document).on('click', '.track-button', function() {
  var macAddress = $(this).data('mac'); // Get MAC address from the selected row
  trackDevice(macAddress); // Call the trackDevice function with the MAC address
});
    
    $('#wifi-scan-button').click(function() {
        wifiScanActive = !wifiScanActive; // Toggle the wifi scan state

        // Update the wifi scan button appearance
        if (wifiScanActive) {
            $(this).text('Stop WiFi Scan').addClass('btn-danger').removeClass('btn-primary');
            wifiScan();
            // Set up the interval for subsequent scans
            intervalId = setInterval(wifiScan, 1000); // 1000 ms = 1 second
        } else {
            $(this).text('Start WiFi Scan').addClass('btn-primary').removeClass('btn-danger');
            // If there's already an interval, clear it
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }
    });

var allDevices = [];  // Array to accumulate all devices

// Define the function to perform a wifi scan
function wifiScan() {
    // Call the /wifi_scan endpoint
    $.post('/wifi_scan', {
        interface: $('#interface-selector').val()
    }, function(data) {
        if(data && data.devices) { // Check if devices array exists in response
            // Merge new devices with previously found devices
            allDevices = [...allDevices, ...data.devices];

            // Eliminate duplicates
            const uniqueDevices = Array.from(new Set(allDevices.map(JSON.stringify))).map(JSON.parse);
            
            populateWifiDetailsTable(uniqueDevices);
        }
    }).fail(function() {
        console.log('Failed to retrieve devices');
    });
}
    
 function parseWifiScanOutput(output) {
    // Parse the output to get new devices
    const newDevices = output.devices;

    // Merge new devices with existing devices
    allDevices = [...allDevices, ...newDevices];

    // Eliminate duplicates
    const uniqueDevices = Array.from(new Set(allDevices.map(JSON.stringify))).map(JSON.parse);

    // Update the Wi-Fi details table
    populateWifiDetailsTable(uniqueDevices);
}

function populateWifiDetailsTable(devices) {
    var tableBody = $('#wifi-details-table tbody');
    tableBody.empty();

    // Convert the devices list to a map with MAC addresses as keys
    const deviceMap = new Map();
    devices.forEach(device => deviceMap.set(device.mac, device));

    // Sort devices based on the clicked column
    const sortColumn = tableBody.data('sort-column');
    const sortDirection = tableBody.data('sort-direction');
    const sortedDevices = sortDevices(Array.from(deviceMap.values()), sortColumn, sortDirection);

    // Update the table body with sorted devices
    sortedDevices.forEach(device => {
        var row = $('<tr>');
        row.append($('<td>').text(device.mac));
        row.append($('<td>').text(device.essid));
        row.append($('<td>').text(device.signal));
        row.append($('<td>').text(device.device_type));
        row.append($('<td>').html('<button class="btn btn-primary btn-sm track-btn" data-mac="' + device.mac + '">Track</button>'));
        tableBody.append(row);
    });

    $('.track-btn').click(function () {
        var macAddress = $(this).data('mac');
        trackDevice(macAddress); // Call the trackDevice function with the MAC address
    });
}
function appendDevicesToTableBody(devices, tbody) {
    devices.forEach(function (device) {
        const row = `<tr>
            <td>
                <button class="btn btn-success track-button" data-mac="${device.mac}">Track</button>
                <button class="btn btn-primary crack-button" data-essid="${device.essid}" data-mac="${device.mac}">Crack</button>
                <button class="btn btn-danger ea-button" data-mac="${device.mac}">EA</button>
            </td>
            <td>${device.mac}</td>
            <td>${device.essid}</td>
            <td>${device.mode}</td>
            <td>${device.channel}</td>
            <td>${device.frequency}</td>
            <td>${device.quality}</td>
            <td>${device.signal}</td>
            <td>${device.noise}</td>
            <td>${device.encryption}</td>
            <td>${device.device_type || ''}</td>
        </tr>`;
        tbody.append(row);
    });

    // Add event listeners to the newly created buttons
    $(".track-button").click(function() {
        console.log('Tracking: ' + $(this).data('mac'));
        var $this = $(this);
        if ($this.text() == "Track") {
            // Start tracking
            $this.text("Stop Tracking");
            $this.addClass("btn-danger");
            $(".track-button").not($this).prop("disabled", true);
            var mac_address = $this.data("mac-address");
            $.post("/track_device", {mac_address: mac_address});
     } else {
            // Stop tracking
            $this.text("Track");
            $this.removeClass("btn-danger");
            $(".track-button").prop("disabled", false);
            $.post("/stop_tracking");
        }
    });
   
    $('.crack-button').click(function() {
        console.log('Beginning to Crack. ESSID: ' + $(this).data('essid') + ', MAC: ' + $(this).data('mac'));
    });

    $('.ea-button').click(function() {
        console.log('Conducting electronic attack on: ' + $(this).data('mac'));
    });
    
    $('#wifi-details-table th').click(function () {
    const column = $(this).data('column');
    const tbody = $('#wifi-details-table tbody');
    const currentSortColumn = tbody.data('sort-column');
    let currentSortDirection = tbody.data('sort-direction');

    // Toggle sort direction if clicking on the same column
    if (column === currentSortColumn) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortDirection = 'asc';
    }

    // Update data attributes with new sort column and direction
    tbody.data('sort-column', column);
    tbody.data('sort-direction', currentSortDirection);

    // Re-populate the table with sorted devices
    populateWifiDetailsTable(allDevices);
    });  
}
function sortDevices(devices, sortColumn, sortDirection) {
    const sortedDevices = [...devices];

    sortedDevices.sort(function (a, b) {
        const valueA = a[sortColumn];
        const valueB = b[sortColumn];

        if (valueA == null || valueA === undefined) {
            return sortDirection === 'asc' ? -1 : 1;
        } else if (valueB == null || valueB === undefined) {
            return sortDirection === 'asc' ? 1 : -1;
        }

        const lowerCaseA = valueA.toString().toLowerCase();
        const lowerCaseB = valueB.toString().toLowerCase();

        if (lowerCaseA < lowerCaseB) {
            return sortDirection === 'asc' ? -1 : 1;
        } else if (lowerCaseA > lowerCaseB) {
            return sortDirection === 'asc' ? 1 : -1;
        } else {
            return 0;
        }
    });

    return sortedDevices;
}

    
});
</script>
</body>
</html>
